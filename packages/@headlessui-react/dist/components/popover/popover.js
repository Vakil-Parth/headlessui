import{createContext as V,createRef as ae,useContext as $,useEffect as K,useMemo as F,useReducer as fe,useRef as Y,useState as Pe}from"react";import{match as H}from'../../utils/match.js';import{forwardRefWithAs as U,render as W,Features as q}from'../../utils/render.js';import{optionalRef as de,useSyncRefs as G}from'../../hooks/use-sync-refs.js';import{useId as k}from'../../hooks/use-id.js';import{Keys as D}from'../keyboard.js';import{isDisabledReactIssue7711 as pe}from'../../utils/bugs.js';import{getFocusableElements as se,Focus as _,focusIn as w,isFocusableElement as ve,FocusableMode as Te}from'../../utils/focus-management.js';import{OpenClosedProvider as Ee,State as z,useOpenClosed as ie}from'../../internal/open-closed.js';import{useResolveButtonType as Se}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as be}from'../../hooks/use-outside-click.js';import{getOwnerDocument as ge}from'../../utils/owner.js';import{useOwnerDocument as Q}from'../../hooks/use-owner.js';import{useEventListener as Re}from'../../hooks/use-event-listener.js';import{Hidden as X,Features as Z}from'../../internal/hidden.js';import{useEvent as b}from'../../hooks/use-event.js';import{useTabDirection as ue,Direction as N}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';var Ae=(c=>(c[c.Open=0]="Open",c[c.Closed=1]="Closed",c))(Ae||{}),Ce=(n=>(n[n.TogglePopover=0]="TogglePopover",n[n.ClosePopover=1]="ClosePopover",n[n.SetButton=2]="SetButton",n[n.SetButtonId=3]="SetButtonId",n[n.SetPanel=4]="SetPanel",n[n.SetPanelId=5]="SetPanelId",n))(Ce||{});let Oe={[0]:r=>({...r,popoverState:H(r.popoverState,{[0]:1,[1]:0})}),[1](r){return r.popoverState===1?r:{...r,popoverState:1}},[2](r,t){return r.button===t.button?r:{...r,button:t.button}},[3](r,t){return r.buttonId===t.buttonId?r:{...r,buttonId:t.buttonId}},[4](r,t){return r.panel===t.panel?r:{...r,panel:t.panel}},[5](r,t){return r.panelId===t.panelId?r:{...r,panelId:t.panelId}}},ee=V(null);ee.displayName="PopoverContext";function J(r){let t=$(ee);if(t===null){let c=new Error(`<${r} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(c,J),c}return t}let te=V(null);te.displayName="PopoverAPIContext";function oe(r){let t=$(te);if(t===null){let c=new Error(`<${r} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(c,oe),c}return t}let re=V(null);re.displayName="PopoverGroupContext";function ce(){return $(re)}let ne=V(null);ne.displayName="PopoverPanelContext";function Me(){return $(ne)}function Le(r,t){return H(t.type,Oe,r,t)}let Ie="div",Fe=U(function(t,c){var O;let o=`headlessui-popover-button-${k()}`,v=`headlessui-popover-panel-${k()}`,a=Y(null),n=G(c,de(e=>{a.current=e})),g=fe(Le,{popoverState:1,button:null,buttonId:o,panel:null,panelId:v,beforePanelSentinel:ae(),afterPanelSentinel:ae()}),[{popoverState:y,button:l,panel:P,beforePanelSentinel:s,afterPanelSentinel:h},i]=g,T=Q((O=a.current)!=null?O:l);K(()=>i({type:3,buttonId:o}),[o,i]),K(()=>i({type:5,panelId:v}),[v,i]);let f=F(()=>{if(!l||!P)return!1;for(let M of document.querySelectorAll("body > *"))if(Number(M==null?void 0:M.contains(l))^Number(M==null?void 0:M.contains(P)))return!0;let e=se(),p=e.indexOf(l),m=(p+e.length-1)%e.length,A=(p+1)%e.length,B=e[m],j=e[A];return!P.contains(B)&&!P.contains(j)},[l,P]),d=F(()=>({buttonId:o,panelId:v,close:()=>i({type:1})}),[o,v,i]),E=ce(),R=E==null?void 0:E.registerPopover,L=b(()=>{var e;return(e=E==null?void 0:E.isFocusWithinPopoverGroup())!=null?e:(T==null?void 0:T.activeElement)&&((l==null?void 0:l.contains(T.activeElement))||(P==null?void 0:P.contains(T.activeElement)))});K(()=>R==null?void 0:R(d),[R,d]),Re(T==null?void 0:T.defaultView,"focus",e=>{var p,m,A,B;y===0&&(L()||!l||!P||(m=(p=s.current)==null?void 0:p.contains)!=null&&m.call(p,e.target)||(B=(A=h.current)==null?void 0:A.contains)!=null&&B.call(A,e.target)||i({type:1}))},!0),be([l,P],(e,p)=>{i({type:1}),ve(p,Te.Loose)||(e.preventDefault(),l==null||l.focus())},y===0);let I=b(e=>{i({type:1});let p=(()=>e?e instanceof HTMLElement?e:"current"in e&&e.current instanceof HTMLElement?e.current:l:l)();p==null||p.focus()}),x=F(()=>({close:I,isPortalled:f}),[I,f]),u=F(()=>({open:y===0,close:I}),[y,I]),S=t,C={ref:n};return<ee.Provider value={g}><te.Provider value={x}><Ee value={H(y,{[0]:z.Open,[1]:z.Closed})}>{W({ourProps:C,theirProps:S,slot:u,defaultTag:Ie,name:"Popover"})}</Ee></te.Provider></ee.Provider>}),he="button",Be=U(function(t,c){let[o,v]=J("Popover.Button"),{isPortalled:a}=oe("Popover.Button"),n=Y(null),g=`headlessui-focus-sentinel-${k()}`,y=ce(),l=y==null?void 0:y.closeOthers,P=Me(),s=P===null?!1:P===o.panelId,h=G(n,c,s?null:e=>e&&v({type:2,button:e})),i=G(n,c),T=Q(n),f=b(e=>{var p,m,A;if(s){if(o.popoverState===1)return;switch(e.key){case D.Space:case D.Enter:e.preventDefault(),(m=(p=e.target).click)==null||m.call(p),v({type:1}),(A=o.button)==null||A.focus();break}}else switch(e.key){case D.Space:case D.Enter:e.preventDefault(),e.stopPropagation(),o.popoverState===1&&(l==null||l(o.buttonId)),v({type:0});break;case D.Escape:if(o.popoverState!==0)return l==null?void 0:l(o.buttonId);if(!n.current||(T==null?void 0:T.activeElement)&&!n.current.contains(T.activeElement))return;e.preventDefault(),e.stopPropagation(),v({type:1});break}}),d=b(e=>{s||e.key===D.Space&&e.preventDefault()}),E=b(e=>{var p,m;pe(e.currentTarget)||t.disabled||(s?(v({type:1}),(p=o.button)==null||p.focus()):(e.preventDefault(),e.stopPropagation(),o.popoverState===1&&(l==null||l(o.buttonId)),v({type:0}),(m=o.button)==null||m.focus()))}),R=b(e=>{e.preventDefault(),e.stopPropagation()}),L=o.popoverState===0,I=F(()=>({open:L}),[L]),x=Se(t,n),u=t,S=s?{ref:i,type:x,onKeyDown:f,onClick:E}:{ref:h,id:o.buttonId,type:x,"aria-expanded":t.disabled?void 0:o.popoverState===0,"aria-controls":o.panel?o.panelId:void 0,onKeyDown:f,onKeyUp:d,onClick:E,onMouseDown:R},C=ue(),O=b(()=>{let e=o.panel;if(!e)return;function p(){H(C.current,{[N.Forwards]:()=>w(e,_.First),[N.Backwards]:()=>w(e,_.Last)})}p()});return<>{W({ourProps:S,theirProps:u,slot:I,defaultTag:he,name:"Popover.Button"})}{L&&!s&&a&&<X id={g}features={Z.Focusable}as="button"type="button"onFocus={O}/>}</>}),De="div",xe=q.RenderStrategy|q.Static,He=U(function(t,c){let[{popoverState:o},v]=J("Popover.Overlay"),a=G(c),n=`headlessui-popover-overlay-${k()}`,g=ie(),y=(()=>g!==null?g===z.Open:o===0)(),l=b(i=>{if(pe(i.currentTarget))return i.preventDefault();v({type:1})}),P=F(()=>({open:o===0}),[o]);return W({ourProps:{ref:a,id:n,"aria-hidden":!0,onClick:l},theirProps:t,slot:P,defaultTag:De,features:xe,visible:y,name:"Popover.Overlay"})}),Ge="div",ke=q.RenderStrategy|q.Static,_e=U(function(t,c){let{focus:o=!1,...v}=t,[a,n]=J("Popover.Panel"),{close:g,isPortalled:y}=oe("Popover.Panel"),l=`headlessui-focus-sentinel-before-${k()}`,P=`headlessui-focus-sentinel-after-${k()}`,s=Y(null),h=G(s,c,u=>{n({type:4,panel:u})}),i=Q(s),T=ie(),f=(()=>T!==null?T===z.Open:a.popoverState===0)(),d=b(u=>{var S;switch(u.key){case D.Escape:if(a.popoverState!==0||!s.current||(i==null?void 0:i.activeElement)&&!s.current.contains(i.activeElement))return;u.preventDefault(),u.stopPropagation(),n({type:1}),(S=a.button)==null||S.focus();break}});K(()=>{var u;t.static||a.popoverState===1&&((u=t.unmount)!=null?u:!0)&&n({type:4,panel:null})},[a.popoverState,t.unmount,t.static,n]),K(()=>{if(!o||a.popoverState!==0||!s.current)return;let u=i==null?void 0:i.activeElement;s.current.contains(u)||w(s.current,_.First)},[o,s,a.popoverState]);let E=F(()=>({open:a.popoverState===0,close:g}),[a,g]),R={ref:h,id:a.panelId,onKeyDown:d,onBlur:o&&a.popoverState===0?u=>{var C,O,e,p,m;let S=u.relatedTarget;!S||!s.current||(C=s.current)!=null&&C.contains(S)||(n({type:1}),(((e=(O=a.beforePanelSentinel.current)==null?void 0:O.contains)==null?void 0:e.call(O,S))||((m=(p=a.afterPanelSentinel.current)==null?void 0:p.contains)==null?void 0:m.call(p,S)))&&S.focus({preventScroll:!0}))}:void 0,tabIndex:-1},L=ue(),I=b(()=>{let u=s.current;if(!u)return;function S(){H(L.current,{[N.Forwards]:()=>{w(u,_.First)},[N.Backwards]:()=>{var C;(C=a.button)==null||C.focus({preventScroll:!0})}})}S()}),x=b(()=>{let u=s.current;if(!u)return;function S(){H(L.current,{[N.Forwards]:()=>{var A,B,j;if(!a.button)return;let C=se(),O=C.indexOf(a.button),e=C.slice(0,O+1),m=[...C.slice(O+1),...e];for(let M of m.slice())if(((B=(A=M==null?void 0:M.id)==null?void 0:A.startsWith)==null?void 0:B.call(A,"headlessui-focus-sentinel-"))||((j=a.panel)==null?void 0:j.contains(M))){let le=m.indexOf(M);le!==-1&&m.splice(le,1)}w(m,_.First,!1)},[N.Backwards]:()=>w(u,_.Last)})}S()});return<ne.Provider value={a.panelId}>{f&&y&&<X id={l}ref={a.beforePanelSentinel}features={Z.Focusable}as="button"type="button"onFocus={I}/>}{W({ourProps:R,theirProps:v,slot:E,defaultTag:Ge,features:ke,visible:f,name:"Popover.Panel"})}{f&&y&&<X id={P}ref={a.afterPanelSentinel}features={Z.Focusable}as="button"type="button"onFocus={x}/>}</ne.Provider>}),we="div",Ne=U(function(t,c){let o=Y(null),v=G(o,c),[a,n]=Pe([]),g=b(f=>{n(d=>{let E=d.indexOf(f);if(E!==-1){let R=d.slice();return R.splice(E,1),R}return d})}),y=b(f=>(n(d=>[...d,f]),()=>g(f))),l=b(()=>{var E;let f=ge(o);if(!f)return!1;let d=f.activeElement;return(E=o.current)!=null&&E.contains(d)?!0:a.some(R=>{var L,I;return((L=f.getElementById(R.buttonId))==null?void 0:L.contains(d))||((I=f.getElementById(R.panelId))==null?void 0:I.contains(d))})}),P=b(f=>{for(let d of a)d.buttonId!==f&&d.close()}),s=F(()=>({registerPopover:y,unregisterPopover:g,isFocusWithinPopoverGroup:l,closeOthers:P}),[y,g,l,P]),h=F(()=>({}),[]),i=t,T={ref:v};return<re.Provider value={s}>{W({ourProps:T,theirProps:i,slot:h,defaultTag:we,name:"Popover.Group"})}</re.Provider>}),Et=Object.assign(Fe,{Button:Be,Overlay:He,Panel:_e,Group:Ne});export{Et as Popover};
