import{useEffect as A,useRef as i}from"react";import{forwardRefWithAs as h,render as y}from'../../utils/render.js';import{useServerHandoffComplete as S}from'../../hooks/use-server-handoff-complete.js';import{useSyncRefs as g}from'../../hooks/use-sync-refs.js';import{Features as p,Hidden as M}from'../../internal/hidden.js';import{focusElement as f,focusIn as T,Focus as b,FocusResult as B}from'../../utils/focus-management.js';import{match as I}from'../../utils/match.js';import{useEvent as P}from'../../hooks/use-event.js';import{useTabDirection as _,Direction as L}from'../../hooks/use-tab-direction.js';import{useIsMounted as d}from'../../hooks/use-is-mounted.js';import{useOwnerDocument as U}from'../../hooks/use-owner.js';import{useEventListener as R}from'../../hooks/use-event-listener.js';import{microTask as H}from'../../utils/micro-task.js';import{useWatch as F}from'../../hooks/use-watch.js';let C="div";var O=(r=>(r[r.None=1]="None",r[r.InitialFocus=2]="InitialFocus",r[r.TabLock=4]="TabLock",r[r.FocusLock=8]="FocusLock",r[r.RestoreFocus=16]="RestoreFocus",r[r.All=30]="All",r))(O||{});let fe=Object.assign(h(function(u,e){let l=i(null),o=g(l,e),{initialFocus:a,containers:r,features:n=30,...c}=u;S()||(n=1);let s=U(l);N({ownerDocument:s},Boolean(n&16));let v=V({ownerDocument:s,container:l,initialFocus:a},Boolean(n&2));x({ownerDocument:s,container:l,containers:r,previousActiveElement:v},Boolean(n&8));let j=_(),E=P(()=>{let m=l.current;!m||I(j.current,{[L.Forwards]:()=>T(m,b.First),[L.Backwards]:()=>T(m,b.Last)})}),k={ref:o};return<>{Boolean(n&4)&&<M as="button"type="button"onFocus={E}features={p.Focusable}/>}{y({ourProps:k,theirProps:c,defaultTag:C,name:"FocusTrap"})}{Boolean(n&4)&&<M as="button"type="button"onFocus={E}features={p.Focusable}/>}</>}),{features:O});function N({ownerDocument:t},u){let e=i(null);R(t==null?void 0:t.defaultView,"focusout",o=>{!u||e.current||(e.current=o.target)},!0),F(()=>{u||((t==null?void 0:t.activeElement)===(t==null?void 0:t.body)&&f(e.current),e.current=null)},[u]);let l=i(!1);A(()=>(l.current=!1,()=>{l.current=!0,H(()=>{!l.current||(f(e.current),e.current=null)})}),[])}function V({ownerDocument:t,container:u,initialFocus:e},l){let o=i(null),a=d();return F(()=>{if(!l)return;let r=u.current;!r||H(()=>{if(!a.current)return;let n=t==null?void 0:t.activeElement;if(e!=null&&e.current){if((e==null?void 0:e.current)===n){o.current=n;return}}else if(r.contains(n)){o.current=n;return}e!=null&&e.current?f(e.current):T(r,b.First)===B.Error&&console.warn("There are no focusable elements inside the <FocusTrap />"),o.current=t==null?void 0:t.activeElement})},[l]),o}function x({ownerDocument:t,container:u,containers:e,previousActiveElement:l},o){let a=d();R(t==null?void 0:t.defaultView,"focus",r=>{if(!o||!a.current)return;let n=new Set(e==null?void 0:e.current);n.add(u);let c=l.current;if(!c)return;let s=r.target;s&&s instanceof HTMLElement?G(n,s)?(l.current=s,f(s)):(r.preventDefault(),r.stopPropagation(),f(c)):f(l.current)},!0)}function G(t,u){var e;for(let l of t)if((e=l.current)!=null&&e.contains(u))return!0;return!1}export{fe as FocusTrap};
