import{Fragment as X,createContext as q,createRef as G,useContext as J,useEffect as Y,useMemo as E,useReducer as Z,useRef as W}from"react";import{useDisposables as V}from'../../hooks/use-disposables.js';import{useId as U}from'../../hooks/use-id.js';import{useIsoMorphicEffect as A}from'../../hooks/use-iso-morphic-effect.js';import{useComputed as Q}from'../../hooks/use-computed.js';import{useSyncRefs as I}from'../../hooks/use-sync-refs.js';import{Features as z,forwardRefWithAs as F,render as k,compact as ee}from'../../utils/render.js';import{match as h}from'../../utils/match.js';import{disposables as B}from'../../utils/disposables.js';import{Keys as y}from'../keyboard.js';import{Focus as L,calculateActiveIndex as te}from'../../utils/calculate-active-index.js';import{isDisabledReactIssue7711 as oe}from'../../utils/bugs.js';import{isFocusableElement as ne,FocusableMode as re,sortByDomNode as ie}from'../../utils/focus-management.js';import{useOpenClosed as ae,State as _,OpenClosedProvider as Te}from'../../internal/open-closed.js';import{useResolveButtonType as ye}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as xe}from'../../hooks/use-outside-click.js';import{Hidden as Oe,Features as me}from'../../internal/hidden.js';import{objectToFormEntries as ge}from'../../utils/form.js';import{getOwnerDocument as Re}from'../../utils/owner.js';import{useEvent as v}from'../../hooks/use-event.js';import{useControllable as ve}from'../../hooks/use-controllable.js';var Le=(n=>(n[n.Open=0]="Open",n[n.Closed=1]="Closed",n))(Le||{}),Se=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n))(Se||{}),Ae=(n=>(n[n.Pointer=0]="Pointer",n[n.Other=1]="Other",n))(Ae||{}),he=(r=>(r[r.OpenListbox=0]="OpenListbox",r[r.CloseListbox=1]="CloseListbox",r[r.SetDisabled=2]="SetDisabled",r[r.SetOrientation=3]="SetOrientation",r[r.GoToOption=4]="GoToOption",r[r.Search=5]="Search",r[r.ClearSearch=6]="ClearSearch",r[r.RegisterOption=7]="RegisterOption",r[r.UnregisterOption=8]="UnregisterOption",r))(he||{});function H(t,i=n=>n){let n=t.activeOptionIndex!==null?t.options[t.activeOptionIndex]:null,e=ie(i(t.options.slice()),u=>u.dataRef.current.domRef.current),o=n?e.indexOf(n):null;return o===-1&&(o=null),{options:e,activeOptionIndex:o}}let Pe={[1](t){return t.disabled||t.listboxState===1?t:{...t,activeOptionIndex:null,listboxState:1}},[0](t){if(t.disabled||t.listboxState===0)return t;let i=t.activeOptionIndex,{value:n,mode:e,compare:o}=t.propsRef.current,u=t.options.findIndex(l=>{let s=l.dataRef.current.value;return h(e,{[1]:()=>n.some(r=>o(r,s)),[0]:()=>o(n,s)})});return u!==-1&&(i=u),{...t,listboxState:0,activeOptionIndex:i}},[2](t,i){return t.disabled===i.disabled?t:{...t,disabled:i.disabled}},[3](t,i){return t.orientation===i.orientation?t:{...t,orientation:i.orientation}},[4](t,i){var o;if(t.disabled||t.listboxState===1)return t;let n=H(t),e=te(i,{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:u=>u.id,resolveDisabled:u=>u.dataRef.current.disabled});return{...t,...n,searchQuery:"",activeOptionIndex:e,activationTrigger:(o=i.trigger)!=null?o:1}},[5]:(t,i)=>{if(t.disabled||t.listboxState===1)return t;let e=t.searchQuery!==""?0:1,o=t.searchQuery+i.value.toLowerCase(),l=(t.activeOptionIndex!==null?t.options.slice(t.activeOptionIndex+e).concat(t.options.slice(0,t.activeOptionIndex+e)):t.options).find(d=>{var r;return!d.dataRef.current.disabled&&((r=d.dataRef.current.textValue)==null?void 0:r.startsWith(o))}),s=l?t.options.indexOf(l):-1;return s===-1||s===t.activeOptionIndex?{...t,searchQuery:o}:{...t,searchQuery:o,activeOptionIndex:s,activationTrigger:1}},[6](t){return t.disabled||t.listboxState===1||t.searchQuery===""?t:{...t,searchQuery:""}},[7]:(t,i)=>{let n={id:i.id,dataRef:i.dataRef},e=H(t,o=>[...o,n]);if(t.activeOptionIndex===null){let{value:o,mode:u,compare:l}=t.propsRef.current,s=i.dataRef.current.value;h(u,{[1]:()=>o.some(r=>l(r,s)),[0]:()=>l(o,s)})&&(e.activeOptionIndex=e.options.indexOf(n))}return{...t,...e}},[8]:(t,i)=>{let n=H(t,e=>{let o=e.findIndex(u=>u.id===i.id);return o!==-1&&e.splice(o,1),e});return{...t,...n,activationTrigger:1}}},j=q(null);j.displayName="ListboxContext";function w(t){let i=J(j);if(i===null){let n=new Error(`<${t} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,w),n}return i}function Ce(t,i){return h(i.type,Pe,t,i)}let De=X,Me=F(function(i,n){let{value:e,defaultValue:o,name:u,onChange:l,by:s=(p,T)=>p===T,disabled:d=!1,horizontal:r=!1,multiple:x=!1,...S}=i;const g=r?"horizontal":"vertical";let O=I(n),[m,f]=ve(e,l,o),b=Z(Ce,{listboxState:1,propsRef:{current:{value:m,onChange:f,mode:x?1:0,compare:v(typeof s=="string"?(p,T)=>{let C=s;return(p==null?void 0:p[C])===(T==null?void 0:T[C])}:s)}},labelRef:G(),buttonRef:G(),optionsRef:G(),disabled:d,orientation:g,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1}),[{listboxState:a,propsRef:c,optionsRef:P,buttonRef:D},M]=b;c.current.value=m,c.current.mode=x?1:0,A(()=>{c.current.onChange=p=>h(c.current.mode,{[0](){return f(p)},[1](){let T=c.current.value.slice(),{compare:C}=c.current,N=T.findIndex($=>C($,p));return N===-1?T.push(p):T.splice(N,1),f(T)}})},[f,c]),A(()=>M({type:2,disabled:d}),[d]),A(()=>M({type:3,orientation:g}),[g]),xe([D,P],(p,T)=>{var C;M({type:1}),ne(T,re.Loose)||(p.preventDefault(),(C=D.current)==null||C.focus())},a===0);let K=E(()=>({open:a===0,disabled:d,value:m}),[a,d,m]),R={ref:O};return<j.Provider value={b}><Te value={h(a,{[0]:_.Open,[1]:_.Closed})}>{u!=null&&m!=null&&ge({[u]:m}).map(([p,T])=><Oe features={me.Hidden}{...ee({key:p,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:p,value:T})}/>)}{k({ourProps:R,theirProps:S,slot:K,defaultTag:De,name:"Listbox"})}</Te></j.Provider>}),Ee="button",Ie=F(function(i,n){var f;let[e,o]=w("Listbox.Button"),u=I(e.buttonRef,n),l=`headlessui-listbox-button-${U()}`,s=V(),d=v(b=>{switch(b.key){case y.Space:case y.Enter:case y.ArrowDown:b.preventDefault(),o({type:0}),s.nextFrame(()=>{e.propsRef.current.value||o({type:4,focus:L.First})});break;case y.ArrowUp:b.preventDefault(),o({type:0}),s.nextFrame(()=>{e.propsRef.current.value||o({type:4,focus:L.Last})});break}}),r=v(b=>{switch(b.key){case y.Space:b.preventDefault();break}}),x=v(b=>{if(oe(b.currentTarget))return b.preventDefault();e.listboxState===0?(o({type:1}),s.nextFrame(()=>{var a;return(a=e.buttonRef.current)==null?void 0:a.focus({preventScroll:!0})})):(b.preventDefault(),o({type:0}))}),S=Q(()=>{if(!!e.labelRef.current)return[e.labelRef.current.id,l].join(" ")},[e.labelRef.current,l]),g=E(()=>({open:e.listboxState===0,disabled:e.disabled,value:e.propsRef.current.value}),[e]),O=i,m={ref:u,id:l,type:ye(i,e.buttonRef),"aria-haspopup":!0,"aria-controls":(f=e.optionsRef.current)==null?void 0:f.id,"aria-expanded":e.disabled?void 0:e.listboxState===0,"aria-labelledby":S,disabled:e.disabled,onKeyDown:d,onKeyUp:r,onClick:x};return k({ourProps:m,theirProps:O,slot:g,defaultTag:Ee,name:"Listbox.Button"})}),Fe="label",ke=F(function(i,n){let[e]=w("Listbox.Label"),o=`headlessui-listbox-label-${U()}`,u=I(e.labelRef,n),l=v(()=>{var x;return(x=e.buttonRef.current)==null?void 0:x.focus({preventScroll:!0})}),s=E(()=>({open:e.listboxState===0,disabled:e.disabled}),[e]);return k({ourProps:{ref:u,id:o,onClick:l},theirProps:i,slot:s,defaultTag:Fe,name:"Listbox.Label"})}),we="ul",Ue=z.RenderStrategy|z.Static,Ge=F(function(i,n){var b;let[e,o]=w("Listbox.Options"),u=I(e.optionsRef,n),l=`headlessui-listbox-options-${U()}`,s=V(),d=V(),r=ae(),x=(()=>r!==null?r===_.Open:e.listboxState===0)();Y(()=>{var c;let a=e.optionsRef.current;!a||e.listboxState===0&&a!==((c=Re(a))==null?void 0:c.activeElement)&&a.focus({preventScroll:!0})},[e.listboxState,e.optionsRef]);let S=v(a=>{switch(d.dispose(),a.key){case y.Space:if(e.searchQuery!=="")return a.preventDefault(),a.stopPropagation(),o({type:5,value:a.key});case y.Enter:if(a.preventDefault(),a.stopPropagation(),e.activeOptionIndex!==null){let{dataRef:c}=e.options[e.activeOptionIndex];e.propsRef.current.onChange(c.current.value)}e.propsRef.current.mode===0&&(o({type:1}),B().nextFrame(()=>{var c;return(c=e.buttonRef.current)==null?void 0:c.focus({preventScroll:!0})}));break;case h(e.orientation,{vertical:y.ArrowDown,horizontal:y.ArrowRight}):return a.preventDefault(),a.stopPropagation(),o({type:4,focus:L.Next});case h(e.orientation,{vertical:y.ArrowUp,horizontal:y.ArrowLeft}):return a.preventDefault(),a.stopPropagation(),o({type:4,focus:L.Previous});case y.Home:case y.PageUp:return a.preventDefault(),a.stopPropagation(),o({type:4,focus:L.First});case y.End:case y.PageDown:return a.preventDefault(),a.stopPropagation(),o({type:4,focus:L.Last});case y.Escape:return a.preventDefault(),a.stopPropagation(),o({type:1}),s.nextFrame(()=>{var c;return(c=e.buttonRef.current)==null?void 0:c.focus({preventScroll:!0})});case y.Tab:a.preventDefault(),a.stopPropagation();break;default:a.key.length===1&&(o({type:5,value:a.key}),d.setTimeout(()=>o({type:6}),350));break}}),g=Q(()=>{var a,c,P;return(P=(a=e.labelRef.current)==null?void 0:a.id)!=null?P:(c=e.buttonRef.current)==null?void 0:c.id},[e.labelRef.current,e.buttonRef.current]),O=E(()=>({open:e.listboxState===0}),[e]),m=i,f={"aria-activedescendant":e.activeOptionIndex===null||(b=e.options[e.activeOptionIndex])==null?void 0:b.id,"aria-multiselectable":e.propsRef.current.mode===1?!0:void 0,"aria-labelledby":g,"aria-orientation":e.orientation,id:l,onKeyDown:S,role:"listbox",tabIndex:0,ref:u};return k({ourProps:f,theirProps:m,slot:O,defaultTag:we,features:Ue,visible:x,name:"Listbox.Options"})}),Ve="li",Be=F(function(i,n){let{disabled:e=!1,value:o,...u}=i,[l,s]=w("Listbox.Option"),d=`headlessui-listbox-option-${U()}`,r=l.activeOptionIndex!==null?l.options[l.activeOptionIndex].id===d:!1,{value:x,compare:S}=l.propsRef.current,g=h(l.propsRef.current.mode,{[1]:()=>x.some(R=>S(R,o)),[0]:()=>S(x,o)}),O=W(null),m=I(n,O);A(()=>{if(l.listboxState!==0||!r||l.activationTrigger===0)return;let R=B();return R.requestAnimationFrame(()=>{var p,T;(T=(p=O.current)==null?void 0:p.scrollIntoView)==null||T.call(p,{block:"nearest"})}),R.dispose},[O,r,l.listboxState,l.activationTrigger,l.activeOptionIndex]);let f=W({disabled:e,value:o,domRef:O});A(()=>{f.current.disabled=e},[f,e]),A(()=>{f.current.value=o},[f,o]),A(()=>{var R,p;f.current.textValue=(p=(R=O.current)==null?void 0:R.textContent)==null?void 0:p.toLowerCase()},[f,O]);let b=v(()=>l.propsRef.current.onChange(o));A(()=>(s({type:7,id:d,dataRef:f}),()=>s({type:8,id:d})),[f,d]);let a=v(R=>{if(e)return R.preventDefault();b(),l.propsRef.current.mode===0&&(s({type:1}),B().nextFrame(()=>{var p;return(p=l.buttonRef.current)==null?void 0:p.focus({preventScroll:!0})}))}),c=v(()=>{if(e)return s({type:4,focus:L.Nothing});s({type:4,focus:L.Specific,id:d})}),P=v(()=>{e||r||s({type:4,focus:L.Specific,id:d,trigger:0})}),D=v(()=>{e||!r||s({type:4,focus:L.Nothing})}),M=E(()=>({active:r,selected:g,disabled:e}),[r,g,e]);return k({ourProps:{id:d,ref:m,role:"option",tabIndex:e===!0?void 0:-1,"aria-disabled":e===!0?!0:void 0,"aria-selected":g,disabled:void 0,onClick:a,onFocus:c,onPointerMove:P,onMouseMove:P,onPointerLeave:D,onMouseLeave:D},theirProps:u,slot:M,defaultTag:Ve,name:"Listbox.Option"})}),xt=Object.assign(Me,{Button:Ie,Label:ke,Options:Ge,Option:Be});export{xt as Listbox};
