import{Fragment as G,computed as g,defineComponent as A,h as U,inject as Q,nextTick as V,onMounted as W,onUnmounted as X,provide as Y,ref as D,toRaw as p,watch as q,watchEffect as K}from"vue";import{Features as H,render as F,omit as $,compact as Z}from'../../utils/render.js';import{useId as j}from'../../hooks/use-id.js';import{Keys as P}from'../../keyboard.js';import{calculateActiveIndex as z,Focus as w}from'../../utils/calculate-active-index.js';import{dom as h}from'../../utils/dom.js';import{useOpenClosed as ee,State as _,useOpenClosedProvider as te}from'../../internal/open-closed.js';import{match as E}from'../../utils/match.js';import{useResolveButtonType as oe}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as le}from'../../hooks/use-outside-click.js';import{Hidden as ie,Features as ue}from'../../internal/hidden.js';import{objectToFormEntries as re}from'../../utils/form.js';import{useControllable as se}from'../../hooks/use-controllable.js';function de(o,m){return o===m}var pe=(u=>(u[u.Open=0]="Open",u[u.Closed=1]="Closed",u))(pe||{}),be=(u=>(u[u.Single=0]="Single",u[u.Multi=1]="Multi",u))(be||{}),fe=(u=>(u[u.Pointer=0]="Pointer",u[u.Other=1]="Other",u))(fe||{});let J=Symbol("ComboboxContext");function L(o){let m=Q(J,null);if(m===null){let u=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,L),u}return m}let Ae=A({name:"Combobox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>de},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(o,{slots:m,attrs:u,emit:I}){let e=D(1),t=D(null),c=D(null),C=D(null),x=D(null),v=D({static:!1,hold:!1}),a=D([]),O=D(null),R=D(1),y=D(!1);function b(l=r=>r){let r=O.value!==null?a.value[O.value]:null,i=ae(l(a.value.slice()),f=>h(f.dataRef.domRef)),s=r?i.indexOf(r):null;return s===-1&&(s=null),{options:i,activeOptionIndex:s}}let n=g(()=>o.multiple?1:0),S=g(()=>o.nullable),[k,M]=se(g(()=>o.modelValue),l=>I("update:modelValue",l),g(()=>o.defaultValue)),d={comboboxState:e,value:k,mode:n,compare(l,r){if(typeof o.by=="string"){let i=o.by;return(l==null?void 0:l[i])===(r==null?void 0:r[i])}return o.by(l,r)},nullable:S,inputRef:c,labelRef:t,buttonRef:C,optionsRef:x,disabled:g(()=>o.disabled),options:a,change(l){M(l)},activeOptionIndex:g(()=>{if(y.value&&O.value===null&&a.value.length>0){let l=a.value.findIndex(r=>!r.dataRef.disabled);if(l!==-1)return l}return O.value}),activationTrigger:R,optionsPropsRef:v,closeCombobox(){y.value=!1,!o.disabled&&e.value!==1&&(e.value=1,O.value=null)},openCombobox(){if(y.value=!0,o.disabled||e.value===0)return;let l=a.value.findIndex(r=>{let i=p(r.dataRef.value);return E(n.value,{[0]:()=>d.compare(p(d.value.value),p(i)),[1]:()=>p(d.value.value).some(f=>d.compare(p(f),p(i)))})});l!==-1&&(O.value=l),e.value=0},goToOption(l,r,i){if(y.value=!1,o.disabled||x.value&&!v.value.static&&e.value===1)return;let s=b();if(s.activeOptionIndex===null){let T=s.options.findIndex(B=>!B.dataRef.disabled);T!==-1&&(s.activeOptionIndex=T)}let f=z(l===w.Specific?{focus:w.Specific,id:r}:{focus:l},{resolveItems:()=>s.options,resolveActiveIndex:()=>s.activeOptionIndex,resolveId:T=>T.id,resolveDisabled:T=>T.dataRef.disabled});O.value=f,R.value=i!=null?i:1,a.value=s.options},selectOption(l){let r=a.value.find(s=>s.id===l);if(!r)return;let{dataRef:i}=r;M(E(n.value,{[0]:()=>i.value,[1]:()=>{let s=p(d.value.value).slice(),f=p(i.value),T=s.findIndex(B=>d.compare(f,p(B)));return T===-1?s.push(f):s.splice(T,1),s}}))},selectActiveOption(){if(d.activeOptionIndex.value===null)return;let{dataRef:l,id:r}=a.value[d.activeOptionIndex.value];M(E(n.value,{[0]:()=>l.value,[1]:()=>{let i=p(d.value.value).slice(),s=p(l.value),f=i.findIndex(T=>d.compare(s,p(T)));return f===-1?i.push(s):i.splice(f,1),i}})),d.goToOption(w.Specific,r)},registerOption(l,r){let i={id:l,dataRef:r},s=b(f=>[...f,i]);if(O.value===null){let f=r.value.value;E(n.value,{[0]:()=>d.compare(p(d.value.value),p(f)),[1]:()=>p(d.value.value).some(B=>d.compare(p(B),p(f)))})&&(s.activeOptionIndex=s.options.indexOf(i))}a.value=s.options,O.value=s.activeOptionIndex,R.value=1},unregisterOption(l){let r=b(i=>{let s=i.findIndex(f=>f.id===l);return s!==-1&&i.splice(s,1),i});a.value=r.options,O.value=r.activeOptionIndex,R.value=1}};le([c,C,x],()=>d.closeCombobox(),g(()=>e.value===0)),Y(J,d),te(g(()=>E(e.value,{[0]:_.Open,[1]:_.Closed})));let N=g(()=>d.activeOptionIndex.value===null?null:a.value[d.activeOptionIndex.value].dataRef.value);return()=>{let{name:l,disabled:r,...i}=o,s={open:e.value===0,disabled:r,activeIndex:d.activeOptionIndex.value,activeOption:N.value,value:k.value};return U(G,[...l!=null&&k.value!=null?re({[l]:k.value}).map(([f,T])=>U(ie,Z({features:ue.Hidden,key:f,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:f,value:T}))):[],F({theirProps:{...u,...$(i,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:s,slots:m,attrs:u,name:"Combobox"})])}}}),Fe=A({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(o,{attrs:m,slots:u}){let I=L("ComboboxLabel"),e=`headlessui-combobox-label-${j()}`;function t(){var c;(c=h(I.inputRef))==null||c.focus({preventScroll:!0})}return()=>{let c={open:I.comboboxState.value===0,disabled:I.disabled.value},C={id:e,ref:I.labelRef,onClick:t};return F({ourProps:C,theirProps:o,slot:c,attrs:m,slots:u,name:"ComboboxLabel"})}}}),Le=A({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(o,{attrs:m,slots:u,expose:I}){let e=L("ComboboxButton"),t=`headlessui-combobox-button-${j()}`;I({el:e.buttonRef,$el:e.buttonRef});function c(v){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(v.preventDefault(),e.openCombobox()),V(()=>{var a;return(a=h(e.inputRef))==null?void 0:a.focus({preventScroll:!0})}))}function C(v){switch(v.key){case P.ArrowDown:v.preventDefault(),v.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),V(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case P.ArrowUp:v.preventDefault(),v.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),V(()=>{e.value.value||e.goToOption(w.Last)})),V(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case P.Escape:if(e.comboboxState.value!==0)return;v.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&v.stopPropagation(),e.closeCombobox(),V(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return}}let x=oe(g(()=>({as:o.as,type:m.type})),e.buttonRef);return()=>{var R,y;let v={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},a={ref:e.buttonRef,id:t,type:x.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(R=h(e.optionsRef))==null?void 0:R.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=h(e.labelRef))==null?void 0:y.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:C,onClick:c};return F({ourProps:a,theirProps:o,slot:v,attrs:m,slots:u,name:"ComboboxButton"})}}}),Be=A({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:o=>!0},setup(o,{emit:m,attrs:u,slots:I,expose:e}){let t=L("ComboboxInput"),c=`headlessui-combobox-input-${j()}`;e({el:t.inputRef,$el:t.inputRef});let C=D(t.value.value),x=()=>{var S;let n=t.value.value;return h(t.inputRef)?typeof o.displayValue!="undefined"?(S=o.displayValue(n))!=null?S:"":typeof n=="string"?n:"":""};const v=D("");let a=!1;function O(n){let S=h(t.inputRef);!S||(S.value=n,a=!0,S.dispatchEvent(new Event("input",{bubbles:!0})),a=!1)}W(()=>{q([t.value,v],()=>{C.value=x()},{flush:"sync",immediate:!0}),q([C,t.comboboxState],([n,S],[k,M])=>{let d=h(t.inputRef);!d||(M===0&&S===1?O(n):n!==k&&(d.value=n))},{immediate:!0})});function R(n){switch(n.key){case P.Backspace:case P.Delete:if(t.mode.value!==0||!t.nullable.value)return;let S=n.currentTarget;requestAnimationFrame(()=>{if(S.value===""){t.change(null);let k=h(t.optionsRef);k&&(k.scrollTop=0),t.goToOption(w.Nothing)}});break;case P.Enter:if(t.comboboxState.value!==0||n.isComposing)return;if(n.preventDefault(),n.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case P.ArrowDown:return n.preventDefault(),n.stopPropagation(),E(t.comboboxState.value,{[0]:()=>t.goToOption(w.Next),[1]:()=>t.openCombobox()});case P.ArrowUp:return n.preventDefault(),n.stopPropagation(),E(t.comboboxState.value,{[0]:()=>t.goToOption(w.Previous),[1]:()=>{t.openCombobox(),V(()=>{t.value.value||t.goToOption(w.Last)})}});case P.Home:case P.PageUp:return n.preventDefault(),n.stopPropagation(),t.goToOption(w.First);case P.End:case P.PageDown:return n.preventDefault(),n.stopPropagation(),t.goToOption(w.Last);case P.Escape:if(t.comboboxState.value!==0)return;n.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&n.stopPropagation(),t.closeCombobox();break;case P.Tab:if(t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function y(n){m("change",n)}function b(n){a||t.openCombobox(),m("change",n)}return()=>{var M,d,N,l,r,i;let n={open:t.comboboxState.value===0},S={"aria-controls":(M=t.optionsRef.value)==null?void 0:M.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(d=t.options.value[t.activeOptionIndex.value])==null?void 0:d.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(r=(N=h(t.labelRef))==null?void 0:N.id)!=null?r:(l=h(t.buttonRef))==null?void 0:l.id,id:c,onKeydown:R,onChange:y,onInput:b,role:"combobox",type:(i=u.type)!=null?i:"text",tabIndex:0,ref:t.inputRef},k=$(o,["displayValue"]);return F({ourProps:S,theirProps:k,slot:n,attrs:u,slots:I,features:H.RenderStrategy|H.Static,name:"ComboboxInput"})}}}),je=A({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(o,{attrs:m,slots:u,expose:I}){let e=L("ComboboxOptions"),t=`headlessui-combobox-options-${j()}`;I({el:e.optionsRef,$el:e.optionsRef}),K(()=>{e.optionsPropsRef.value.static=o.static}),K(()=>{e.optionsPropsRef.value.hold=o.hold});let c=ee(),C=g(()=>c!==null?c.value===_.Open:e.comboboxState.value===0);return ne({container:g(()=>h(e.optionsRef)),enabled:g(()=>e.comboboxState.value===0),accept(x){return x.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:x.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(x){x.setAttribute("role","none")}}),()=>{var O,R,y,b;let x={open:e.comboboxState.value===0},v={"aria-activedescendant":e.activeOptionIndex.value===null||(O=e.options.value[e.activeOptionIndex.value])==null?void 0:O.id,"aria-labelledby":(b=(R=h(e.labelRef))==null?void 0:R.id)!=null?b:(y=h(e.buttonRef))==null?void 0:y.id,id:t,ref:e.optionsRef,role:"listbox"},a=$(o,["hold"]);return F({ourProps:v,theirProps:a,slot:x,attrs:m,slots:u,features:H.RenderStrategy|H.Static,visible:C.value,name:"ComboboxOptions"})}}}),Ne=A({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:m,attrs:u,expose:I}){let e=L("ComboboxOption"),t=`headlessui-combobox-option-${j()}`,c=D(null);I({el:c,$el:c});let C=g(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),x=g(()=>E(e.mode.value,{[0]:()=>e.compare(p(e.value.value),p(o.value)),[1]:()=>p(e.value.value).some(b=>e.compare(p(b),p(o.value)))})),v=g(()=>({disabled:o.disabled,value:o.value,domRef:c}));W(()=>e.registerOption(t,v)),X(()=>e.unregisterOption(t)),K(()=>{e.comboboxState.value===0&&(!C.value||e.activationTrigger.value!==0&&V(()=>{var b,n;return(n=(b=h(c))==null?void 0:b.scrollIntoView)==null?void 0:n.call(b,{block:"nearest"})}))});function a(b){if(o.disabled)return b.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function O(){if(o.disabled)return e.goToOption(w.Nothing);e.goToOption(w.Specific,t)}function R(){o.disabled||C.value||e.goToOption(w.Specific,t,0)}function y(){o.disabled||!C.value||e.optionsPropsRef.value.hold||e.goToOption(w.Nothing)}return()=>{let{disabled:b}=o,n={active:C.value,selected:x.value,disabled:b},S={id:t,ref:c,role:"option",tabIndex:b===!0?void 0:-1,"aria-disabled":b===!0?!0:void 0,"aria-selected":x.value,disabled:void 0,onClick:a,onFocus:O,onPointermove:R,onMousemove:R,onPointerleave:y,onMouseleave:y};return F({ourProps:S,theirProps:o,slot:n,attrs:u,slots:m,name:"ComboboxOption"})}}});export{Ae as Combobox,Le as ComboboxButton,Be as ComboboxInput,Fe as ComboboxLabel,Ne as ComboboxOption,je as ComboboxOptions};
